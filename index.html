<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hell Pizza - Weighing Tracker</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111111">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        /* Hell Pizza Premium Redesign - Minimalist & Bold (Tablet Compatible) */
        /* Replaced CSS variables with static values for legacy support */

        @import url('https://fonts.googleapis.com/css2?family=Pirata+One&family=Roboto:wght@400;500;900&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #000000;
            /* --hell-black */
            color: #E1D8B7;
            /* --hell-parchment */
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 40px;
        }

        /* Header & Logo */
        .header {
            text-align: center;
            margin-bottom: 60px;
            padding-bottom: 20px;
        }

        .logo-img {
            max-width: 250px;
            height: auto;
        }

        .subtitle {
            font-family: 'Pirata One', cursive;
            font-size: 3rem;
            color: #FE0000;
            /* --hell-red */
            text-transform: uppercase;
            letter-spacing: 6px;
            margin-top: 5px;
            opacity: 1;
        }

        /* Screens */
        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .screen.active {
            display: block;
            opacity: 1;
        }

        /* Typography Helpers */
        .screen-title {
            font-family: 'Pirata One', cursive;
            font-size: 4rem;
            text-align: center;
            margin-bottom: 60px;
            color: #FE0000;
            /* --hell-red */
            line-height: 1;
        }

        /* Staff Grid - Minimalist Cards */
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 40px;
            padding: 0 20px;
        }

        .staff-btn {
            background: transparent;
            border: 2px solid #FE0000;
            color: #FE0000;
            font-family: 'Pirata One', cursive;
            font-size: 2rem;
            padding: 20px;
            aspect-ratio: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .staff-btn:hover {
            background: #FE0000;
            /* --hell-red */
            border-color: #FE0000;
            /* --hell-red */
            color: #000000;
            /* --hell-black */
            transform: scale(1.05);
        }

        /* Pizza List Layout */
        .pizza-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 50px;
            border-bottom: 1px solid #E1D8B7;
            /* --hell-parchment */
            padding-bottom: 20px;
        }

        .back-btn {
            background: transparent;
            border: none;
            color: #E1D8B7;
            /* --hell-parchment */
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            padding-left: 0;
            transition: color 0.2s;
        }

        .back-btn:hover {
            color: #FE0000;
            /* --hell-red */
        }

        .current-staff {
            font-family: 'Pirata One', cursive;
            font-size: 2.5rem;
            color: #E1D8B7;
            /* --hell-parchment */
        }

        #currentStaffName {
            color: #FE0000;
            /* --hell-red */
        }

        /* Minimalist List Items */
        .pizza-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0;
        }

        .pizza-item {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            align-items: center;
            padding: 25px 0;
            border-bottom: 1px solid #222;
            position: relative;
            transition: background 0.2s;
        }

        .pizza-item:hover {
            background: #0a0a0a;
        }

        .pizza-name-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .pizza-name {
            font-family: 'Roboto', sans-serif;
            font-weight: 900;
            font-size: 1.5rem;
            text-transform: uppercase;
            color: #E1D8B7;
            /* --hell-parchment */
            letter-spacing: 1px;
        }

        .pizza-status {
            font-family: 'Roboto', sans-serif;
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: right;
            padding-right: 20px;
        }

        /* Buttons */
        .weigh-btn {
            background: transparent;
            border: 1px solid #FE0000;
            /* --hell-red */
            color: #FE0000;
            /* --hell-red */
            padding: 10px 30px;
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            min-width: 180px;
            transition: all 0.2s;
        }

        .weigh-btn:hover {
            background: #FE0000;
            /* --hell-red */
            color: #000000;
            /* --hell-black */
        }

        .weigh-btn.weighed {
            border-color: #333;
            color: #333;
        }

        /* Stale Pizza - Design Led (Border removed) */
        /* .pizza-item.stale-pizza {} rule removed */

        .pizza-item.stale-pizza .pizza-name {
            color: #FE0000;
            /* --hell-red */
        }

        .pizza-item.stale-pizza .pizza-status {
            color: #FE0000;
            /* --hell-red */
            font-weight: bold;
        }

        .pizza-item.recent-pizza .pizza-name {
            color: #FFD700;
            /* Yellow */
        }

        .pizza-item.recent-pizza .pizza-status {
            color: #FFD700;
            /* Yellow */
            font-weight: bold;
        }

        .pizza-times {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
            font-weight: normal;
        }

        .pizza-item.stale-pizza::after {
            content: '!';
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            background: #000000;
            /* --hell-black */
            color: #FE0000;
            /* --hell-red */
            font-weight: bold;
            font-size: 0.8rem;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #FE0000;
            /* --hell-red */
            border-radius: 50%;
        }

        /* Leaderboard Styles */
        .leaderboard-section {
            margin-top: 60px;
            padding-top: 40px;
            border-top: 1px solid #333;
            text-align: center;
        }

        .leaderboard-title {
            font-family: 'Pirata One', cursive;
            font-size: 2.5rem;
            color: #FE0000;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: #0a0a0a;
            border: 1px solid #222;
            font-family: 'Roboto', sans-serif;
        }

        .leaderboard-top {
            border: 1px solid #FE0000;
            box-shadow: 0 0 12px rgba(254, 0, 0, 0.3);
            background: #0f0000;
        }

        .leaderboard-rank {
            font-weight: 900;
            color: #FE0000;
            width: 30px;
            text-align: left;
        }

        .leaderboard-name {
            flex-grow: 1;
            text-align: left;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .leaderboard-count {
            color: #FE0000;
            font-weight: 900;
            font-size: 1.2rem;
        }

        .leaderboard-label {
            font-size: 0.7rem;
            color: #666;
            margin-left: 5px;
        }

        /* Tablet Optimization */
        @media (max-width: 768px) {
            .screen-title {
                font-size: 3rem;
            }

            .pizza-item {
                grid-template-columns: 1fr auto;
                grid-template-rows: auto auto;
                gap: 10px;
            }

            .pizza-name {
                grid-column: 1 / -1;
            }

            .pizza-status {
                text-align: left;
                grid-column: 1;
                padding-right: 0;
            }

            .weigh-btn {
                grid-column: 2;
                min-width: auto;
            }
        }

        /* --- Banner Removal Hack --- */
        /* This targets common IDs and styles used by free hosts like Tiiny.host to inject banners */
        #tiiny-host-banner,
        .tiiny-host-banner,
        div[style*="fixed"][style*="bottom: 0"],
        div[style*="fixed"][style*="bottom:0"],
        iframe[src*="tiiny.host"],
        img[alt*="tiiny"],
        a[href*="tiiny.host"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            pointer-events: none !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header"> <!-- SVG Scales & Pizza Logo -->
            <svg width="220" height="160" viewBox="0 0 220 160" xmlns="http://www.w3.org/2000/svg" class="logo-img"
                style="display:block;margin:0 auto;">
                <rect x="107" y="40" width="6" height="110" fill="#E1D8B7" rx="3" />
                <rect x="75" y="148" width="70" height="6" fill="#E1D8B7" rx="3" />
                <rect x="20" y="52" width="180" height="5" fill="#E1D8B7" rx="2" />
                <line x1="40" y1="57" x2="25" y2="115" stroke="#E1D8B7" stroke-width="1.5" />
                <line x1="60" y1="57" x2="75" y2="115" stroke="#E1D8B7" stroke-width="1.5" />
                <line x1="160" y1="57" x2="145" y2="115" stroke="#E1D8B7" stroke-width="1.5" />
                <line x1="180" y1="57" x2="195" y2="115" stroke="#E1D8B7" stroke-width="1.5" />
                <rect x="20" y="115" width="60" height="4" fill="#E1D8B7" rx="2" />
                <rect x="140" y="115" width="60" height="4" fill="#E1D8B7" rx="2" />
                <path d="M155 113 L185 113 L170 75 Z" fill="#FE0000" />
                <path d="M158 110 L182 110 L170 78 Z" fill="#FFD700" />
                <circle cx="164" cy="100" r="3" fill="#FE0000" />
                <circle cx="174" cy="93" r="3" fill="#FE0000" />
                <circle cx="170" cy="104" r="3" fill="#FE0000" />
            </svg>
            <p class="subtitle">Pizza Weighing</p>
        </header>

        <!-- Staff Selection Screen -->
        <div id="staffScreen" class="screen active">
            <h2 class="screen-title">Select Name</h2>
            <div class="staff-grid">
                <button class="staff-btn" data-staff="Sam">Sam</button>
                <button class="staff-btn" data-staff="Fox">Fox</button>
                <button class="staff-btn" data-staff="Ash">Ash</button>
                <button class="staff-btn" data-staff="Cam">Cam</button>
                <button class="staff-btn" data-staff="Dave">Dave</button>
                <button class="staff-btn" data-staff="Toby">Toby</button>
                <button class="staff-btn" data-staff="Kahn">Kahn</button>
            </div>

            <!-- Leaderboard Section -->
            <div class="leaderboard-section">
                <h3 class="leaderboard-title">Top Pizza Weighers</h3>
                <div id="leaderboardList" class="leaderboard-list">
                    <!-- Leaderboard items will be generated by JS -->
                </div>
            </div>
        </div>

        <!-- Pizza Weighing Screen -->
        <div id="pizzaScreen" class="screen">
            <div class="pizza-header">
                <button id="backBtn" class="back-btn">Back to Staff</button>
                <h2 class="current-staff">Staff: <span id="currentStaffName"></span></h2>
            </div>

            <div class="pizza-list" id="pizzaList">
                <!-- Pizza items will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Inlined Application Logic -->
    <script>
        // Hell Pizza Weighing Tracker App

        // Pizza menu list
        const PIZZAS = [
            'Beast', 'Brimstone', 'Buffalo', 'Burger Pizza', 'Cursed', 'Damned',
            'Death By Chicken', 'Envy', 'Gluttony', 'Greed', 'Grimm', 'Limbo',
            'Lust/Deluxe', 'Mayhem', 'Mordor', 'Morning After', 'Pandemonium',
            'Pride', 'Purgatory', 'Serpent', 'Sinister', 'Trouble', 'Unearthly', 'Wrath'
        ];

        // ===== GOOGLE SHEETS SYNC CONFIG =====
        const GOOGLE_SHEETS_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbx-VRjPjFI1zn26kp2_SYdgWesVz2mtfPr0pPR41BJPMwsLjHrmDAPMK4ZNPiw0tJik/exec';
        const BACKGROUND_SYNC_INTERVAL = 20 * 60 * 1000; // 20 minutes

        // Start background sync
        setInterval(() => {
            console.log('⏰ Background sync triggered');
            syncToGoogleSheets(true);
        }, BACKGROUND_SYNC_INTERVAL);

        // Sync to Google Sheets
        function syncToGoogleSheets(silent) {
            const data = loadData();
            const records = [];

            for (const staffName in data) {
                if (data.hasOwnProperty(staffName)) {
                    for (const pizzaName in data[staffName]) {
                        const entry = data[staffName][pizzaName];
                        let history = [];

                        if (Array.isArray(entry)) {
                            history = entry;
                        } else if (entry) {
                            history = [entry];
                        }

                        history.forEach(weighedDate => {
                            records.push({
                                staff: staffName,
                                pizza: pizzaName,
                                date: weighedDate,
                                daysAgo: calculateDaysAgo(weighedDate)
                            });
                        });
                    }
                }
            }

            // Send payload
            const xhr = new XMLHttpRequest();
            xhr.open('POST', GOOGLE_SHEETS_WEBHOOK_URL, true);
            xhr.setRequestHeader('Content-Type', 'text/plain;charset=utf-8');

            xhr.onload = function () {
                if (xhr.status === 200 || xhr.status === 302) {
                    if (!silent) console.log('✅ Synced to Google Sheets');
                } else {
                    if (!silent) console.log('❌ Error syncing to Google Sheets');
                }
            };

            // Fire and forget mostly
            xhr.send(JSON.stringify({ records: records }));
        }

        function calculateDaysAgo(dateString) {
            const weighedDate = new Date(dateString);
            const today = new Date();
            weighedDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            const diffTime = today - weighedDate;
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        }

        // Staff list
        const STAFF = ['Sam', 'Fox', 'Ash', 'Cam', 'Dave', 'Toby', 'Kahn'];

        // Current state
        let currentStaff = null;

        // DOM Elements
        const staffScreen = document.getElementById('staffScreen');
        const pizzaScreen = document.getElementById('pizzaScreen');
        const currentStaffName = document.getElementById('currentStaffName');
        const pizzaList = document.getElementById('pizzaList');
        const backBtn = document.getElementById('backBtn');

        // Initialize app
        function init() {
            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker
                    .register('./sw.js')
                    .then(() => { console.log('Service Worker Registered'); })
                    .catch((err) => { console.log('SW Registration Failed'); });
            }

            // Keep Screen On (Wake Lock)
            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen')
                    .then(() => console.log('Screen Wake Lock Active'))
                    .catch((err) => console.log('Wake Lock Error:', err));

                // Re-request lock if page becomes visible again
                document.addEventListener('visibilitychange', async () => {
                    if (document.visibilityState === 'visible' && 'wakeLock' in navigator) {
                        try { await navigator.wakeLock.request('screen'); }
                        catch (e) { }
                    }
                });
            }

            setupStaffButtons();
            setupBackButton();
            loadData();
            updateLeaderboard();
        }

        // Update the leaderboard display
        function updateLeaderboard() {
            const data = loadData();
            const counts = [];

            // Calculate totals for each staff member
            STAFF.forEach(staffName => {
                let total = 0;
                if (data[staffName]) {
                    for (const pizza in data[staffName]) {
                        const entry = data[staffName][pizza];
                        if (Array.isArray(entry)) {
                            total += entry.length;
                        } else if (entry) {
                            total += 1;
                        }
                    }
                }
                counts.push({ name: staffName, count: total });
            });

            // Sort by count descending
            counts.sort((a, b) => b.count - a.count);

            // Render to DOM
            const leaderboardContainer = document.getElementById('leaderboardList');
            if (leaderboardContainer) {
                leaderboardContainer.innerHTML = '';
                counts.forEach((item, index) => {
                    const el = document.createElement('div');
                    const isTop = index === 0 && item.count > 0;
                    el.className = 'leaderboard-item' + (isTop ? ' leaderboard-top' : '');
                    el.innerHTML = `
                        <span class="leaderboard-rank">${isTop ? '😈' : '#' + (index + 1)}</span>
                        <span class="leaderboard-name" style="${isTop ? 'color:#FE0000;font-weight:900;' : ''}">${item.name}${isTop ? ' 👑' : ''}</span>
                        <span class="leaderboard-count">${item.count}<span class="leaderboard-label">PIZZAS</span></span>
                    `;
                    leaderboardContainer.appendChild(el);
                });
            }
        }

        // Setup staff selection buttons
        function setupStaffButtons() {
            const staffButtons = document.querySelectorAll('.staff-btn');
            staffButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const staffName = btn.getAttribute('data-staff');
                    selectStaff(staffName);
                });
            });
        }

        // Setup back button
        function setupBackButton() {
            backBtn.addEventListener('click', () => {
                showStaffScreen();
            });
        }

        // Select a staff member
        function selectStaff(staffName) {
            currentStaff = staffName;
            currentStaffName.textContent = staffName;
            renderPizzaList();
            showPizzaScreen();
        }

        // Render the pizza list for current staff
        function renderPizzaList() {
            pizzaList.innerHTML = '';

            PIZZAS.forEach(pizza => {
                const pizzaItem = createPizzaItem(pizza);
                pizzaList.appendChild(pizzaItem);
            });
        }

        // Create a pizza item element
        function createPizzaItem(pizzaName) {
            const item = document.createElement('div');
            item.className = 'pizza-item';

            const nameWrapper = document.createElement('div');
            nameWrapper.className = 'pizza-name-wrapper';

            const name = document.createElement('div');
            name.className = 'pizza-name';
            name.textContent = pizzaName;

            const count = getWeighedCount(currentStaff, pizzaName);
            const countDisplay = document.createElement('div');
            countDisplay.className = 'pizza-times';
            countDisplay.textContent = `Weighed: ${count} times`;

            nameWrapper.appendChild(name);
            nameWrapper.appendChild(countDisplay);

            const status = document.createElement('div');
            status.className = 'pizza-status';

            const lastWeighed = getLastWeighed(currentStaff, pizzaName);
            status.textContent = formatLastWeighed(lastWeighed);

            const button = document.createElement('button');
            button.className = 'weigh-btn';

            if (lastWeighed && isToday(lastWeighed)) {
                button.textContent = 'Undo Today';
                button.classList.add('weighed');
            } else {
                button.textContent = 'Mark as Weighed';

                // Check highlight logic
                if (isStale(lastWeighed)) {
                    item.classList.add('stale-pizza');
                } else if (isRecent(lastWeighed)) {
                    item.classList.add('recent-pizza');
                }
            }

            button.addEventListener('click', () => {
                toggleWeighed(currentStaff, pizzaName);
                renderPizzaList();
            });

            item.appendChild(nameWrapper);
            item.appendChild(status);
            item.appendChild(button);

            return item;
        }

        // Get total count of times weighed
        function getWeighedCount(staffName, pizzaName) {
            const data = loadData();
            if (data[staffName] && data[staffName][pizzaName]) {
                const entry = data[staffName][pizzaName];
                return Array.isArray(entry) ? entry.length : 1;
            }
            return 0;
        }

        // Get last weighed date for a staff member and pizza
        function getLastWeighed(staffName, pizzaName) {
            const data = loadData();
            if (data[staffName] && data[staffName][pizzaName]) {
                const entry = data[staffName][pizzaName];
                if (Array.isArray(entry)) {
                    return entry.length > 0 ? entry[entry.length - 1] : null;
                }
                return entry;
            }
            return null;
        }

        // Toggle weighed status (Mark as weighed / Undo)
        function toggleWeighed(staffName, pizzaName) {
            const data = loadData();

            if (!data[staffName]) {
                data[staffName] = {};
            }

            const today = new Date().toISOString().split('T')[0];
            let history = data[staffName][pizzaName];

            // Normalize to array
            if (!history) {
                history = [];
            } else if (!Array.isArray(history)) {
                history = [history];
            }

            const lastEntry = history.length > 0 ? history[history.length - 1] : null;

            // If already weighed TODAY, then undo (remove last entry)
            if (lastEntry === today) {
                history.pop();
            } else {
                // Otherwise mark as weighed today
                history.push(today);
            }

            // Save back
            if (history.length > 0) {
                data[staffName][pizzaName] = history;
            } else {
                delete data[staffName][pizzaName];
            }

            saveData(data);

            // Trigger sync and update local UI
            updateLeaderboard();
            setTimeout(() => syncToGoogleSheets(true), 1000);
        }

        // Format last weighed date for display
        function formatLastWeighed(dateString) {
            if (!dateString) {
                return 'Never weighed';
            }

            const weighedDate = new Date(dateString);
            const today = new Date();

            // Reset time to midnight for accurate day comparison
            weighedDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);

            const diffTime = today - weighedDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return 'Weighed Today';
            } else if (diffDays === 1) {
                return 'Weighed Yesterday';
            } else if (diffDays < 7) {
                return 'Weighed ' + diffDays + ' days ago';
            } else {
                return 'Weighed ' + dateString;
            }
        }

        // Check if a date is today
        function isToday(dateString) {
            const today = new Date().toISOString().split('T')[0];
            return dateString === today;
        }

        // Check if a pizza is considered "stale" (not weighed in > 7 days)
        function isStale(dateString) {
            if (!dateString) return true; // Never weighed is stale

            const diffDays = calculateDaysAgo(dateString);
            return diffDays > 7;
        }

        // Check if a pizza is "recent" (weighed within last 7 days but not today)
        function isRecent(dateString) {
            if (!dateString) return false;
            const diffDays = calculateDaysAgo(dateString);
            return diffDays > 0 && diffDays <= 7;
        }

        // Load data from localStorage
        function loadData() {
            const dataString = localStorage.getItem('hellPizzaWeighingData');
            if (dataString) {
                try {
                    return JSON.parse(dataString);
                } catch (e) {
                    console.error('Error loading data:', e);
                    return {};
                }
            }
            return {};
        }

        // Save data to localStorage
        function saveData(data) {
            try {
                localStorage.setItem('hellPizzaWeighingData', JSON.stringify(data));
            } catch (e) {
                console.error('Error saving data:', e);
                alert('Error saving data. Please check browser storage settings.');
            }
        }

        // Show staff selection screen
        function showStaffScreen() {
            staffScreen.classList.add('active');
            pizzaScreen.classList.remove('active');
            currentStaff = null;
        }

        // Show pizza weighing screen
        function showPizzaScreen() {
            staffScreen.classList.remove('active');
            pizzaScreen.classList.add('active');
        }

        // Initialize the app when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>